
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dad's Interview Bot</title>
    <style>
      body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; color:#111;}
      header{display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid #eee;}
      .provider{font-size:14px; padding:6px 10px; border:1px solid #ccc; border-radius:10px; background:#f8f8f8; cursor:pointer;}
      .wrap{max-width:800px; margin:24px auto; padding:0 20px;}
      .primary{padding:12px 16px; border-radius:12px; border:1px solid #445; background:#eef; cursor:pointer; font-weight:600;}
      .glyph{width:140px; height:140px; border-radius:999px; border:10px solid #cfe; display:flex; align-items:center; justify-content:center; margin:20px auto; background:#e9fff0; font-size:48px;}
      .spinner{border:4px solid #eee; border-top:4px solid #2a6; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin: 16px auto;}
      @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
      .audio{margin-top:10px;}
      .note{font-size:13px; color:#666; margin-top:10px;}
      .log{white-space:pre-wrap; background:#fafafa; border:1px solid #eee; padding:10px; border-radius:10px; margin-top:14px; font-size:12px; color:#333;}
    </style>
  </head>
  <body>
    <header>
      <h3 style="margin:0">Dad's Interview Bot</h3>
      <button id="providerBtn" class="provider">Provider: <b id="provName">google</b> ▾</button>
    </header>
    <div class="wrap">
      <button id="startBtn" class="primary">Start</button>
      <div id="stateArea" class="note" style="margin-top:10px;">Ready</div>
      <div id="uiArea"></div>
      <audio id="player" class="audio" controls></audio>
      <div class="log" id="log"></div>
    </div>
    <script>
      const log = (m) => { const el = document.getElementById('log'); el.textContent += (m+'\n'); el.scrollTop = el.scrollHeight; };
      const state = { provider: localStorage.getItem('provider') || (new URLSearchParams(location.search).get('provider') || 'google'), phase: 'idle', rec:null, stream:null };
      document.getElementById('provName').textContent = state.provider;

      document.getElementById('providerBtn').addEventListener('click', () => {
        state.provider = state.provider === 'google' ? 'openai' : 'google';
        localStorage.setItem('provider', state.provider);
        document.getElementById('provName').textContent = state.provider;
        log('Provider switched to '+state.provider);
      });

      const setPhase = (p, msg) => {
        state.phase = p;
        document.getElementById('stateArea').textContent = msg || p;
        const ui = document.getElementById('uiArea');
        ui.innerHTML = '';
        if (p === 'recording') {
          const g = document.createElement('div'); g.className='glyph'; g.textContent='●'; ui.appendChild(g);
          const t = document.createElement('div'); t.className='note'; t.textContent='Recording…'; ui.appendChild(t);
        } else if (p === 'thinking') {
          const s = document.createElement('div'); s.className='spinner'; ui.appendChild(s);
          const t = document.createElement('div'); t.className='note'; t.textContent='Thinking…'; ui.appendChild(t);
        }
      };

      const btn = document.getElementById('startBtn');
      btn.addEventListener('click', async () => {
        if (state.phase === 'idle' || state.phase === 'done' || state.phase === 'playing') {
          await startRecording();
        } else if (state.phase === 'recording') {
          await stopAndSend();
        }
      });

      async function startRecording(){
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
          state.stream = stream;
          const rec = new MediaRecorder(stream, { mimeType:'audio/webm' });
          const chunks = [];
          rec.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
          rec.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            setPhase('thinking', 'Thinking…');
            const res = await fetch('/api/ask-audio?provider='+encodeURIComponent(state.provider), {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ text: 'say hello' })
            });
            const j = await res.json().catch(()=>null);
            if (!res.ok || !j?.ok) {
              log('[ASK] error '+(j?.error||res.status)+': '+(j?.status||'')+' '+(j?.body? (j.body.slice(0,120)+'…') : ''));
              setPhase('idle','Ready');
              return;
            }
            if (j.text) log('[ASK] '+j.text);
            setPhase('idle','Ready');
          };
          state.rec = rec; rec.start(); btn.textContent='Conversation in progress (tap to stop)'; setPhase('recording','Recording…');
        } catch(e) {
          log('Mic error: '+e.message);
        }
      }

      async function stopAndSend(){
        try {
          if (state.rec && state.rec.state !== 'inactive') state.rec.stop();
          if (state.stream) state.stream.getTracks().forEach(t=>t.stop());
          document.getElementById('startBtn').textContent='Start';
        } catch(e) { log('Stop error: '+e.message); }
      }
    </script>
  </body>
</html>

